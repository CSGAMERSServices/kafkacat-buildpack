#! /bin/bash

APP=kafkacat
VERSION=1.3.1
APP_NAME="${APP}-${VERSION}"
DL_URL="https://github.com/edenhill/${APP}/archive/${VERSION}.tar.gz"
FILE_NAME="${APP_NAME}.tar.gz"

set -xe

if [ -n $2/${FILE_NAME} ]; then
  mkdir -p $2
  pushd $2
  echo "------> Downloading kafkacat source - ${DL_URL}"
  curl --silent -L ${DL_URL} | tar zx

  echo "------> Bootstrapping kafkacat"
  pushd ${APP_NAME}
  ./bootstrap.sh
  cp kafkacat ..
  popd

  echo "------> Cleaning up source"
  rm -rf ${APP_NAME}

  popd
else
  echo "------> kafkacat found in cache dir!"
fi

echo "------> Copying to BUILD_DIR"
mkdir -p $1/bin
cp $2/kafkacat $1/bin

echo ""
echo "------> Success! kafkacat installed."
echo ""

echo ""
echo "------> Installing Kafka certs"
ls -ah $3
if [ -f $3/KAFKA_URL ] && [ -f $3/KAFKA_CLIENT_CERT ] && [ -f $3/KAFKA_CLIENT_CERT_KEY ] && [ -f $3/KAFKA_TRUSTED_CERT ]; then
  pushd $1
  mkdir -p ssl
  pushd ssl
  cp $3/KAFKA_CLIENT_CERT ssl/client.pem
  cp $3/KAFKA_CLIENT_CERT_KEY ssl/client.key
  cp $3/KAFKA_TRUSTED_CERT ssl/server.pem
  popd
  popd
fi

echo ""