#! /bin/bash

APP=kafkacat
VERSION=1.3.1
APP_NAME="${APP}.${VERSION}"
DL_URL="https://github.com/edenhill/${APP}/archive/${VERSION}.tar.gz"
FILE_NAME="${APP_NAME}.tar.gz"

set -xe

if [ -n $2/${FILE_NAME} ]; then
  pushd $2
  echo "------> Downloading kafkacat source - ${DL_URL} -> ${2}/${FILE_NAME}"
  curl --silent -L ${DL_URL} | tar zx

  echo "------> Installing dependencies"
  apt update
  apt install librdkafka-dev libyajl-dev

  echo "------> Configuring kafkacat"
  pushd ${VERSION}
  configure --enable-static --enable-json
  make
  popd

  echo "------> Cleaning up source"
  rm -rf ${APP_NAME}
  rm ${FILE_NAME}
  popd
else
  echo "------> kafkacat found in cache dir!"
fi

echo "------> Copying to BUILD_DIR"
mkdir -p $1/bin
cp $2/kafka $1/bin

echo ""
echo "------> Success! kafkacat installed."
echo ""

$1/bin/kafka -h